<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil | NutrirVida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="Styles/styless.css">
    <link rel="stylesheet" href="Styles/perfil.css">
</head>

<body>

    <nav>
        <a class="logo" href="index.html">
            <img src="Imagens/logomarca.png" alt="NutrirVida" class="logo-img">
        </a>

        <ul class="nav-list">
            <li><a href="index.html">Início</a></li>
            <li><a href="Loja.html">Loja</a></li>
            <li><a href="index.html#nossas-categorias">Categorias</a></li>
            <li><a href="Loja.html">Pacotes</a></li>
            <li><a href="contato.html">Contato</a></li>
        </ul>

        <div class="nav-right">
            <div class="nav-icons">
                <a href="carrinho.html" style="position: relative; display: inline-flex;" aria-label="Ver carrinho">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-count" class="cart-badge"></span>
                </a>

                <div class="profile-container">
                    <a href="javascript:void(0)" class="profile-icon">
                        <i class="fas fa-user"></i>
                    </a>
                    <ul class="profile-dropdown">
                        <li><a href="perfil.html"><i class="fas fa-user-circle"></i> Meu Perfil</a></li>
                        <li><a href="pedidos.html"><i class="fas fa-box"></i> Meus Pedidos</a></li>
                        <li class="dropdown-divider"></li>
                        <li><a href="javascript:void(0)" onclick="deslogar()" class="logout"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
                    </ul>
                </div>
            </div>
            <div class="mobile-menu" id="mobile-menu">
                <div class="line1"></div>
                <div class="line2"></div>
                <div class="line3"></div>
            </div>
        </div>
    </nav>

    <div class="container profile-layout">
        <aside class="profile-sidebar-container">
            <div class="user-profile-card">
                <div class="user-avatar-main">
                    <i class="fas fa-user"></i>
                </div>
                <h3 id="display-user-name">Carregando...</h3>
            </div>

            <section class="side-nav">
                <button class="nav-link active" onclick="openTab(event, 'meus-dados')">
                    <i class="fas fa-id-card"></i> Meus Dados
                </button>
                <button class="nav-link" onclick="openTab(event, 'minhas-compras')">
                    <i class="fas fa-shopping-bag"></i> Minhas Compras
                </button>
                <div class="nav-divider"></div>
                <a href="javascript:void(0)" onclick="deslogar()" class="nav-link logout-link">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </section>
        </aside>

        <main class="profile-content">
            <section id="meus-dados" class="tab-content active">
                <h2>Meus Dados</h2>
                <form class="profile-form" id="form-perfil">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Nome Completo</label>
                            <input type="text" id="api-nome" placeholder="Seu nome">
                        </div>
                        <div class="input-group">
                            <label>E-mail</label>
                            <input type="email" id="api-email" placeholder="seu@email.com">
                        </div>
                        <div class="input-group">
                            <label>Telefone</label>
                            <input type="text" id="api-telefone" placeholder="(00) 00000-0000">
                        </div>
                        <div class="input-group">
                            <label>CPF</label>
                            <input type="text" id="api-cpf" readonly class="readonly" style="background-color: #f4f4f4; cursor: not-allowed;">
                        </div>
                        <div class="input-group">
                            <label>Data de Nascimento (Não editável)</label>
                            <input type="date" id="api-nascimento" readonly class="readonly" style="background-color: #f4f4f4; cursor: not-allowed;">
                        </div>
                    </div>
                    <button type="submit" class="btn-save-changes">Salvar Alterações</button>
                </form>
            </section>

            <section id="minhas-compras" class="tab-content">
                <h2>Minhas Compras</h2>
                <div class="orders-container">
                    <p>Você ainda não possui pedidos realizados.</p>
                </div>
            </section>
        </main>
    </div>

       <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>NUTRIR<span>VIDA</span></h3>
                <p>Seu parceiro de confiança para todos os seus suplementos esportivos.</p>
            </div>

            <div class="footer-column">
                <h3>Links rápidos</h3>
                <ul>
                    <li><a href="index.html">Início</a></li>
                    <li><a href="Loja.html">Loja</a></li>
                    <li><a href="contato.html">Contato</a></li>
                    <li><a href="#">Sobre nós</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Informações legais</h3>
                <ul>
                    <li><a href="#">Termos de uso</a></li>
                    <li><a href="#">Termos e condições</a></li>
                    <li><a href="#">Política de privacidade</a></li>
                    <li><a href="#">Entrega</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Siga-nos</h3>
                <div class="social-icons">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                </div>
                <h3>Formas de pagamento</h3>
                <div class="payment-icons">
                    <i class="fas fa-credit-card" title="Cartão de Crédito"></i>
                    <i class="fas fa-mobile-alt" title="Pix"></i>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2026 FitSuplementos. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="javascript/database.js"></script>
    <script src="javascript/script.js"></script>

    <script>
        // Funções de Máscara
        function formatarCPF(v) {
            v = v.replace(/\D/g, "");
            if (v.length > 11) v = v.slice(0, 11);
            return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        }

        function formatarTelefone(v) {
            v = v.replace(/\D/g, "");
            if (v.length > 11) v = v.slice(0, 11);
            return v.replace(/^(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
        }

        // Alternar entre abas
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("nav-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // CARREGAR DADOS DO PERFIL
        async function carregarDadosPerfil() {
            const { data: { user }, error } = await _supabase.auth.getUser();

            if (error || !user) {
                localStorage.clear();
                window.location.replace('login.html');
                return;
            }

            const meta = user.user_metadata;

            if(document.getElementById('display-user-name')) 
                document.getElementById('display-user-name').innerText = meta.full_name || "Usuário";
            
            if(document.getElementById('api-nome')) 
                document.getElementById('api-nome').value = meta.full_name || "";

            if(document.getElementById('api-email')) 
                document.getElementById('api-email').value = user.email || "";

            // Aplicando Máscara de Telefone ao carregar
            if(document.getElementById('api-telefone')) {
                let tel = meta.telefone || "";
                document.getElementById('api-telefone').value = tel.length >= 10 ? formatarTelefone(tel) : tel;
            }

            // Aplicando Máscara de CPF ao carregar
            if(document.getElementById('api-cpf')) {
                let cpf = meta.cpf || "";
                document.getElementById('api-cpf').value = cpf.length === 11 ? formatarCPF(cpf) : cpf;
            }

            if(document.getElementById('api-nascimento')) 
                document.getElementById('api-nascimento').value = meta.nascimento || "";
        }

        // SALVAR ALTERAÇÕES
        document.getElementById('form-perfil').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const novoNome = document.getElementById('api-nome').value;
            const novoEmail = document.getElementById('api-email').value;
            // Remove a máscara antes de salvar o telefone para manter o banco limpo apenas com números
            const novoTelefone = document.getElementById('api-telefone').value.replace(/\D/g, "");

            const { error: errorMeta } = await _supabase.auth.updateUser({
                email: novoEmail,
                data: { 
                    full_name: novoNome,
                    telefone: novoTelefone
                }
            });

            if (errorMeta) {
                alert("Erro ao atualizar: " + errorMeta.message);
            } else {
                alert("Dados atualizados com sucesso!");
                carregarDadosPerfil();
            }

            btn.innerText = originalText;
            btn.disabled = false;
        });

        // Evento para aplicar máscara em tempo real enquanto o usuário digita no telefone
        document.getElementById('api-telefone').addEventListener('input', (e) => {
            e.target.value = formatarTelefone(e.target.value);
        });

        document.addEventListener('DOMContentLoaded', carregarDadosPerfil);

        window.onpageshow = function(event) {
            if (event.persisted) window.location.reload();
        };
    </script>
</body>

</html>