<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil | NutrirVida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="Styles/styless.css">
    <link rel="stylesheet" href="Styles/perfil.css">
    <style>
        /* Estilos específicos para os Cards de Pedidos */
        .order-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f9f9f9;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .order-id {
            font-weight: bold;
            color: #333;
        }

        .order-date {
            font-size: 0.85rem;
            color: #888;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Cores dos Status */
        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        .status-aprovado {
            background: #d4edda;
            color: #155724;
        }

        .status-enviado {
            background: #cce5ff;
            color: #004085;
        }

        .status-finalizado {
            background: #d1d1d1;
            color: #333;
        }

        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        .order-details p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .order-items {
            color: #555;
            font-style: italic;
        }
    </style>
</head>

<body>

    <nav>
        <a class="logo" href="index.html">
            <img src="Imagens/logomarca.png" alt="NutrirVida" class="logo-img">
        </a>

        <ul class="nav-list">
            <li><a href="index.html">Início</a></li>
            <li><a href="Loja.html">Loja</a></li>
            <li><a href="index.html#nossas-categorias">Categorias</a></li>
            <li><a href="Loja.html">Pacotes</a></li>
            <li><a href="contato.html">Contato</a></li>
        </ul>

        <div class="nav-right">
            <div class="nav-icons">
                <a href="carrinho.html" style="position: relative; display: inline-flex;" aria-label="Ver carrinho">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-count" class="cart-badge"></span>
                </a>

                <div class="profile-container">
                    <a href="javascript:void(0)" class="profile-icon">
                        <i class="fas fa-user"></i>
                    </a>
                    <ul class="profile-dropdown">
                        <li><a href="perfil.html"><i class="fas fa-user-circle"></i> Meu Perfil</a></li>
                        
                        <li class="dropdown-divider"></li>
                        <li><a href="javascript:void(0)" onclick="deslogar()" class="logout"><i
                                    class="fas fa-sign-out-alt"></i> Sair</a></li>
                    </ul>
                </div>
            </div>
            <div class="mobile-menu" id="mobile-menu">
                <div class="line1"></div>
                <div class="line2"></div>
                <div class="line3"></div>
            </div>
        </div>
    </nav>

    <div class="container profile-layout">
        <aside class="profile-sidebar-container">
            <div class="user-profile-card">
                <div class="user-avatar-main">
                    <i class="fas fa-user"></i>
                </div>
                <h3 id="display-user-name">Carregando...</h3>
            </div>

            <section class="side-nav">
                <button class="nav-link active" onclick="openTab(event, 'meus-dados')">
                    <i class="fas fa-id-card"></i> Meus Dados
                </button>
                <button class="nav-link" onclick="openTab(event, 'minhas-compras')">
                    <i class="fas fa-shopping-bag"></i> Minhas Compras
                </button>
                <div class="nav-divider"></div>
                <a href="javascript:void(0)" onclick="deslogar()" class="nav-link logout-link">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </section>
        </aside>

        <main class="profile-content">
            <section id="meus-dados" class="tab-content active">
                <h2>Meus Dados</h2>
                <form class="profile-form" id="form-perfil">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Nome Completo</label>
                            <input type="text" id="api-nome" placeholder="Seu nome">
                        </div>
                        <div class="input-group">
                            <label>E-mail</label>
                            <input type="email" id="api-email" placeholder="seu@email.com">
                        </div>
                        <div class="input-group">
                            <label>Telefone</label>
                            <input type="text" id="api-telefone" placeholder="(00) 00000-0000">
                        </div>
                        <div class="input-group">
                            <label>CPF</label>
                            <input type="text" id="api-cpf" readonly class="readonly"
                                style="background-color: #f4f4f4; cursor: not-allowed;">
                        </div>
                        <div class="input-group">
                            <label>Data de Nascimento</label>
                            <input type="date" id="api-nascimento" readonly class="readonly"
                                style="background-color: #f4f4f4; cursor: not-allowed;">
                        </div>
                    </div>
                    <button type="submit" class="btn-save-changes">Salvar Alterações</button>
                </form>
            </section>

            <section id="minhas-compras" class="tab-content" style="display: none;">
                <h2>Minhas Compras</h2>
                <div class="orders-container" id="lista-pedidos">
                    <p>Carregando seus pedidos...</p>
                </div>
            </section>
        </main>
    </div>

    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>NUTRIR<span>VIDA</span></h3>
                <p>Seu parceiro de confiança para todos os seus suplementos esportivos.</p>
            </div>

            <div class="footer-column">
                <h3>Links rápidos</h3>
                <ul>
                    <li><a href="index.html">Início</a></li>
                    <li><a href="Loja.html">Loja</a></li>
                    <li><a href="contato.html">Contato</a></li>

                </ul>
            </div>

            <div class="footer-column">
                <h3>Informações legais</h3>
                <ul>
                    <li><a href="#">Termos de uso</a></li>
                    <li><a href="#">Termos e condições</a></li>
                    <li><a href="#">Política de privacidade</a></li>

                </ul>
            </div>

            <div class="footer-column">
                <h3>Siga-nos</h3>
                <div class="social-icons">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/nutrirvidasuplementos?igsh=cWplanlxZWFkNTV6&utm_source=qr"
                        aria-label="Instagram"><i class="fab fa-instagram"></i></a>

                </div>
                <h3>Formas de pagamento</h3>
                <div class="payment-icons">
                    <i class="fas fa-credit-card" title="Cartão de Crédito"></i>
                    <i class="fas fa-mobile-alt" title="Pix"></i>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2025 NutrirVida. Todos os direitos reservados.</p>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="javascript/database.js"></script>
    <script src="javascript/script.js"></script>

    <script>
        // Funções de Máscara
        function formatarCPF(v) {
            v = v.replace(/\D/g, "");
            if (v.length > 11) v = v.slice(0, 11);
            return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        }

        function formatarTelefone(v) {
            v = v.replace(/\D/g, "");
            if (v.length > 11) v = v.slice(0, 11);
            return v.replace(/^(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
        }

        // Alternar entre abas
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("nav-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // CARREGAR DADOS DO PERFIL E PEDIDOS
        async function carregarDadosPerfil() {
            const { data: { user }, error } = await _supabase.auth.getUser();

            if (error || !user) {
                localStorage.clear();
                window.location.replace('login.html');
                return;
            }

            const meta = user.user_metadata;

            // Preenche Interface
            if (document.getElementById('display-user-name'))
                document.getElementById('display-user-name').innerText = meta.full_name || "Usuário";

            if (document.getElementById('api-nome'))
                document.getElementById('api-nome').value = meta.full_name || "";

            if (document.getElementById('api-email'))
                document.getElementById('api-email').value = user.email || "";

            if (document.getElementById('api-telefone')) {
                let tel = meta.telefone || "";
                document.getElementById('api-telefone').value = tel.length >= 10 ? formatarTelefone(tel) : tel;
            }

            if (document.getElementById('api-cpf')) {
                let cpf = meta.cpf || "";
                document.getElementById('api-cpf').value = cpf.length === 11 ? formatarCPF(cpf) : cpf;
            }

            if (document.getElementById('api-nascimento'))
                document.getElementById('api-nascimento').value = meta.nascimento || "";

            // Chama a função para carregar os pedidos
            buscarPedidosDoUsuario(user.email);
        }

        // BUSCAR PEDIDOS NO SUPABASE
        async function buscarPedidosDoUsuario(email) {
            const container = document.getElementById('lista-pedidos');

            const { data: pedidos, error } = await _supabase
                .from('pedidos')
                .select('*')
                .eq('cliente_email', email)
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = "<p>Erro ao carregar pedidos.</p>";
                return;
            }

            if (pedidos.length === 0) {
                container.innerHTML = "<p>Você ainda não possui pedidos realizados.</p>";
                return;
            }

            container.innerHTML = pedidos.map(pedido => {
                const data = new Date(pedido.created_at).toLocaleDateString('pt-BR');

                // Lógica de classe CSS baseada no status
                let statusClass = 'status-pendente';
                const s = pedido.status.toLowerCase();
                if (s.includes('aprovado') || s.includes('pago')) statusClass = 'status-aprovado';
                if (s.includes('enviado') || s.includes('rota')) statusClass = 'status-enviado';
                if (s.includes('finalizado') || s.includes('entregue')) statusClass = 'status-finalizado';
                if (s.includes('cancelado')) statusClass = 'status-cancelado';

                // Formata os itens para exibição
                const nomesItens = pedido.itens.map(i => `${i.quantidade}x ${i.nome}`).join(', ');

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-id">Pedido #${pedido.id.toString().slice(-5)}</div>
                                <div class="order-date">Realizado em ${data}</div>
                            </div>
                            <span class="status-badge ${statusClass}">${pedido.status}</span>
                        </div>
                        <div class="order-details">
                            <p class="order-items"><strong>Produtos:</strong> ${nomesItens}</p>
                            <p><strong>Total:</strong> R$ ${parseFloat(pedido.total).toFixed(2).replace('.', ',')}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // SALVAR ALTERAÇÕES
        document.getElementById('form-perfil').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const novoNome = document.getElementById('api-nome').value;
            const novoEmail = document.getElementById('api-email').value;
            const novoTelefone = document.getElementById('api-telefone').value.replace(/\D/g, "");

            const { error: errorMeta } = await _supabase.auth.updateUser({
                email: novoEmail,
                data: {
                    full_name: novoNome,
                    telefone: novoTelefone
                }
            });

            if (errorMeta) {
                alert("Erro ao atualizar: " + errorMeta.message);
            } else {
                alert("Dados atualizados com sucesso!");
                carregarDadosPerfil();
            }

            btn.innerText = originalText;
            btn.disabled = false;
        });

        document.getElementById('api-telefone').addEventListener('input', (e) => {
            e.target.value = formatarTelefone(e.target.value);
        });

        document.addEventListener('DOMContentLoaded', carregarDadosPerfil);

        window.onpageshow = function (event) {
            if (event.persisted) window.location.reload();
        };
    </script>
</body>

</html>